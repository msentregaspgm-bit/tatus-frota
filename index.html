<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Status da Frota - Souza</title>
  <link rel="manifest" href="manifest.json">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.css" />
  <style>
    body { background-color: #fff; font-family: 'Segoe UI', sans-serif; padding: 15px; transition: background-color 0.3s, color 0.3s; }
    body.dark-mode { background-color: #1c1c1c; color: #fff; }
    h1 { color: #2e7d32; font-weight: 700; margin-bottom: 20px; text-align: center; }
    body.dark-mode h1 { color: #a5d6a7; }
    .card { border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); transition: all 0.2s; background-color: #fff; color: #000; }
    body.dark-mode .card { background-color: #2b2b2b; color: #fff; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .status { font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem; }
    .status-carregado { color: #198754; }
    .status-descarregando { color: #ff9800; }
    .status-parado { color: #dc3545; }
    #map { height: 450px; border-radius: 15px; margin-top: 20px; }
    .footer { text-align: center; color: #6c757d; margin-top: 20px; font-size: 0.9rem; }
    .logo-container { text-align: center; margin-bottom: 10px; }
    .logo-container img { width: 160px; border-radius: 10px; }
    .map-legend { position: absolute; bottom: 20px; right: 20px; background: rgba(255,255,255,0.95); padding: 8px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 0.9rem; }
    .map-legend div { display: flex; align-items: center; margin-bottom: 4px; }
    .map-legend span { display: inline-block; width: 16px; height: 16px; margin-right: 6px; border-radius: 3px; }
    .summary-box { background: #e8f5e9; border-radius: 12px; padding: 10px 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    body.dark-mode .summary-box { background: #2e2e2e; color: #fff; }
    .filter-bar select { width: 24%; font-size: 0.9rem; }
    .btn-darkmode { border-radius: 30px; padding: 6px 20px; }
    .truck-label { color: white; font-weight: 600; text-shadow: 0 0 4px rgba(0,0,0,0.8); font-size: 12px; }
  </style>
</head>
<body>
  <div class="container position-relative">
    <div class="logo-container">
      <img src="logo.png" alt="Logo Souza">
    </div>

    <div class="text-center mb-3 d-flex justify-content-center gap-2">
      <button id="refreshBtn" class="btn btn-success btn-sm">üîÑ Atualizar</button>
      <button id="darkModeBtn" class="btn btn-outline-dark btn-sm btn-darkmode">üåô Modo Escuro</button>
    </div>

    <div class="filter-bar d-flex justify-content-between mb-2">
      <select id="filtroStatus" class="form-select form-select-sm"><option value="">Todos os Status</option></select>
      <select id="filtroProduto" class="form-select form-select-sm"><option value="">Todos os Produtos</option></select>
      <select id="filtroCidade" class="form-select form-select-sm"><option value="">Todas as Cidades</option></select>
      <select id="filtroDestino" class="form-select form-select-sm"><option value="">Todos os Destinos</option></select>
    </div>

    <div id="resumoContainer" class="summary-box">
      <strong>Resumo:</strong>
      <div id="resumoTexto" class="mt-1 text-secondary small">Carregando dados...</div>
    </div>

    <div id="map" class="mb-2"></div>
    <div class="map-legend">
      <div><span style="background:green;"></span>Carregado</div>
      <div><span style="background:orange;"></span>Descarregando</div>
      <div><span style="background:red;"></span>Vazio</div>
    </div>

    <div id="frotaContainer" class="row g-3 mt-2"></div>

    <div class="footer">¬© 2025 Controle de Frota | Souza Transportes</div>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxd4LpN7OzVpJGCsm_5we6rQTqubEB-0UB0KvyYQuZrvc0P61ohWIhgMc7gWO9XYgpc/exec";
    let map, markers = [], dadosFrota = [];

    function getTruckIcon(color) {
      return L.divIcon({ className: "truck-marker", html: `<div style="font-size:22px;color:${color};">üöõ</div>`, iconSize: [24, 24], iconAnchor: [12, 12] });
    }

    function aplicarDeslocamento(lat, lon) {
      const deslocamento = 0.02 * (Math.random() - 0.5);
      return [lat + deslocamento, lon + deslocamento];
    }

    async function geocodeCidade(cidade) {
      try {
        const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cidade + ', Brasil')}`);
        const data = await resp.json();
        if (data && data.length > 0) return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      } catch (e) { console.warn('Erro ao geocodificar', cidade); }
      return null;
    }

    async function atualizarMapa(dados) {
      if (!map) {
        map = L.map('map', { fullscreenControl: true }).setView([-15.78, -47.93], 5);
        const hybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=y,m&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], attribution: 'Map data ¬© Google Maps' }).addTo(map);
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' });
        L.control.layers({ "üõ∞Ô∏è H√≠brido (Rodovias)": hybrid, "üó∫Ô∏è OpenStreetMap": osm }).addTo(map);
      }

      markers.forEach(m => map.removeLayer(m));
      markers = [];
      const group = [];

      for (const v of dados) {
        const cidade = v["Posi√ß√£o"] || "";
        const frota = v.Frota || "";
        const status = (v.Status || "").toLowerCase();
        const color = status.includes("carregado") ? "green" : status.includes("descarregando") ? "orange" : "red";

        let pos = null;
        const lat = parseFloat(v.Latitude);
        const lon = parseFloat(v.Longitude);

        if (!isNaN(lat) && !isNaN(lon)) {
          pos = aplicarDeslocamento(lat, lon);
        } else {
          const latlng = await geocodeCidade(cidade);
          if (latlng) pos = aplicarDeslocamento(latlng[0], latlng[1]);
        }

        if (pos) {
          const icon = getTruckIcon(color);
          const marker = L.marker(pos, { icon }).addTo(map);
          marker.bindPopup(`<b>${frota}</b><br>${v.Status}<br>${v.Produto}<br>${cidade}<br><b>Destino:</b> ${v.Destino || '-'}`);

          const label = L.divIcon({ className: 'truck-label', html: frota, iconSize: [100, 20], iconAnchor: [50, -15] });
          L.marker(pos, { icon: label }).addTo(map);

          markers.push(marker);
          group.push(marker);
        }
      }

      if (group.length) {
        const groupLayer = L.featureGroup(group);
        map.fitBounds(groupLayer.getBounds(), { padding: [30, 30] });
      }
    }

    function renderizarFrota(dados) {
      const container = document.getElementById("frotaContainer");
      const resumoEl = document.getElementById("resumoTexto");
      container.innerHTML = "";

      const total = dados.length;
      const carregado = dados.filter(v => v.Status.toLowerCase().includes("carregado")).length;
      const descarregando = dados.filter(v => v.Status.toLowerCase().includes("descarregando")).length;
      const parado = total - carregado - descarregando;

      resumoEl.innerHTML = `Total: <b>${total}</b> ve√≠culos | Carregados: <span class="text-success"><b>${carregado}</b></span> | Descarregando: <span class="text-warning"><b>${descarregando}</b></span> | Vazios: <span class="text-danger"><b>${parado}</b></span>`;

      dados.forEach(v => {
        const status = (v.Status || '').toLowerCase();
        const statusClass = status.includes('carregado') ? 'status-carregado' : status.includes('descarregando') ? 'status-descarregando' : 'status-parado';
        const card = `<div class="col-6 col-md-3"><div class="card p-2"><h6 class="card-title mb-1">${v.Frota || '-'}</h6><p class="status ${statusClass}">${v.Status || '-'}</p><p class="mb-0"><strong>Produto:</strong> ${v.Produto || '-'}</p><p class="mb-0"><strong>Posi√ß√£o:</strong> ${v["Posi√ß√£o"] || '-'}</p><p class="mb-0"><strong>Destino:</strong> ${v.Destino || '-'}</p><button class="btn btn-sm btn-outline-success mt-1" onclick="destacarCaminhao('${v.Frota}')">üìç Mapa</button></div></div>`;
        container.innerHTML += card;
      });

      atualizarMapa(dados);
    }

    function aplicarFiltros() {
      const fStatus = document.getElementById("filtroStatus").value.toLowerCase();
      const fProduto = document.getElementById("filtroProduto").value.toLowerCase();
      const fCidade = document.getElementById("filtroCidade").value.toLowerCase();
      const fDestino = document.getElementById("filtroDestino").value.toLowerCase();
      const filtrados = dadosFrota.filter(v =>
        (!fStatus || v.Status.toLowerCase().includes(fStatus)) &&
        (!fProduto || (v.Produto || '').toLowerCase().includes(fProduto)) &&
        (!fCidade || (v["Posi√ß√£o"] || '').toLowerCase().includes(fCidade)) &&
        (!fDestino || (v.Destino || '').toLowerCase().includes(fDestino))
      );
      renderizarFrota(filtrados);
    }

    function preencherFiltros(dados) {
      const statusSet = new Set(), produtoSet = new Set(), cidadeSet = new Set(), destinoSet = new Set();
      dados.forEach(v => { statusSet.add(v.Status); produtoSet.add(v.Produto); cidadeSet.add(v["Posi√ß√£o"]); destinoSet.add(v.Destino); });
      const preencher = (id, set) => { const sel = document.getElementById(id); set.forEach(v => { if (v) sel.innerHTML += `<option value="${v}">${v}</option>`; }); };
      preencher("filtroStatus", statusSet);
      preencher("filtroProduto", produtoSet);
      preencher("filtroCidade", cidadeSet);
      preencher("filtroDestino", destinoSet);
    }

    async function buscarDados() {
      const container = document.getElementById("frotaContainer");
      container.innerHTML = "<p class='text-center text-secondary'>üîÑ Carregando...</p>";
      try {
        const response = await fetch(scriptURL + '?t=' + Date.now());
        const data = await response.json();
        dadosFrota = data;
        preencherFiltros(data);
        renderizarFrota(data);
      } catch (error) {
        container.innerHTML = "<p class='text-center text-danger'>Erro ao carregar.</p>";
        console.error(error);
      }
    }

    function destacarCaminhao(frota) {
      const marker = markers.find(m => m.getPopup && m.getPopup().getContent().includes(frota));
      if (marker) { map.setView(marker.getLatLng(), 10); marker.openPopup(); }
    }

    document.getElementById('refreshBtn').addEventListener('click', buscarDados);
    document.getElementById('darkModeBtn').addEventListener('click', () => document.body.classList.toggle('dark-mode'));
    document.querySelectorAll('.filter-bar select').forEach(sel => sel.addEventListener('change', aplicarFiltros));

    window.onload = () => { buscarDados(); setInterval(buscarDados, 18000000); };

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').then(() => console.log('SW registrado.'));
    }
  </script>
</body>
</html>
